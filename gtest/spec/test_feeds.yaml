title: Feeds

programs:
  - id: 1
    path: target/wasm32-unknown-unknown/release/gear_feeds_router.wasm

  - id: 2
    path: target/wasm32-unknown-unknown/release/gear_feeds_channel.wasm
    source:
      kind: id
      value: 9

fixtures:
  - title: Test GEAR Feeds Contracts

    messages:
      - &register_message
        destination: 1
        source:
          kind: id
          value: 9
        payload:
          kind: custom
          value:
            register: 0x0200000000000000000000000000000000000000000000000000000000000000 # id of 2

      - &subscribe_message
        destination: 2
        source:
          kind: id
          value: 5
        payload:
          kind: custom
          value: subscribe

      - &post_message
        destination: 2
        source:
          kind: id
          value: 9
        payload:
          kind: custom
          value:
            post: "Hello world"

      - &feed_message
        destination: 2
        source:
          kind: id
          value: 5
        payload:
          kind: custom
          value: channelFeed

    expected:
      - step: 0
        messages:
          - *register_message
          - *subscribe_message
          - *post_message
          - *feed_message

      - step: 1
        messages:
          - *subscribe_message
          - *post_message
          - *feed_message
          - &meta_message
            destination: 2
            source:
              kind: id
              value: 1
            payload:
              kind: custom
              value: meta

      - step: 2
        messages:
          - *post_message
          - *feed_message
          - *meta_message
        log:
          - &subscribe_success
            destination: 5
            source:
              kind: id
              value: 1
            payload:
              kind: custom
              value:
                singleMessage:
                  text: success
                  timestamp: 0

      - step: 3
        messages:
          - *feed_message
          - *meta_message
        log:
          - *subscribe_success
          - &post_to_9_log
            destination: 9
            source:
              kind: id
              value: 1
            payload:
              kind: custom
              value:
                singleMessage:
                  text: Hello world
                  timestamp: 2
          - &post_to_5_log
            destination: 5
            source:
              kind: id
              value: 1
            payload:
              kind: custom
              value:
                singleMessage:
                  text: Hello world
                  timestamp: 2
          - &post_success
            destination: 9
            source:
              kind: id
              value: 1
            payload:
              kind: custom
              value:
                singleMessage:
                  text: success
                  timestamp: 0

      - step: 4
        messages:
          - *meta_message
        log:
          - *subscribe_success
          - *post_to_9_log
          - *post_to_5_log
          - *post_success
          - &feed_response
            destination: 5
            source:
              kind: id
              value: 1
            payload:
              kind: custom
              value:
                messageList:
                  - text: Channel Test was created
                    timestamp: 0
                  - text: Hello world
                    timestamp: 2

      - step: 5
         # Channel responds with Meta
        messages:
          - destination: 1
            source:
              kind: id
              value: 2
            payload:
              kind: custom
              value:
                metadata:
                  name: Test
                  description: Test description
                  owner_id: 0x0900000000000000000000000000000000000000000000000000000000000000
        log:
          - *subscribe_success
          - *post_to_9_log
          - *post_to_5_log
          - *post_success
          - *feed_response

      - step: 7
        # Router responds with Channel
        log:
          - *subscribe_success
          - *post_to_9_log
          - *post_to_5_log
          - *post_success
          - *feed_response
          - destination: 9
            source:
              kind: id
              value: 1
            payload:
              kind: custom
              value:
                - channel:
                  id: 0x0200000000000000000000000000000000000000000000000000000000000000
                  name: Test
                  description: Test description
                  owner_id: 0x0900000000000000000000000000000000000000000000000000000000000000