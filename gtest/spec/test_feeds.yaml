title: Feeds

programs:
  - id: 1
    path: target/wasm32-unknown-unknown/release/gear_feeds_router.wasm

  - id: 2
    path: target/wasm32-unknown-unknown/release/gear_feeds_channel.wasm
    source:
      kind: id
      value: 9

fixtures:
  - title: Test GEAR Feeds Contracts

    messages:
      - destination: 1
        source:
          kind: id
          value: 9
        payload:
          kind: custom
          value:
            register: 0x0200000000000000000000000000000000000000000000000000000000000000 # id of 2

      - destination: 2
        payload:
          kind: custom
          value: subscribe # is this an action?

      - destination: 2
        payload:
          kind: custom
          value:
            post: "Hello world"

      - destination: 2
        payload:
          kind: custom
          value: channelFeed

    expected:
      - step: 1
        messages:
          - destination: 2
            source:
              kind: id
              value: 1
            payload:
              kind: custom
              value: meta
              
      - step: 2
         # Channel responds with Meta
        messages: 
        - destination: 1
          source:
            kind: id
            value: 2
          payload:
            kind: custom
            value:
              metadata:
                name: Test
                owner_id: 0x0900000000000000000000000000000000000000000000000000000000000000
        log: []

        # Router responds with [Channel] on success
        - destination: 0
          source:
            kind: id
            value: 1
          payload:
            kind: custom
            value: 
              - channel:
                  id: ???
                  name: Test
                  owner_id: ???
              - channel:
                  id: ???
                  name: Test
                  owner_id: ???

        # Subscription success
        - destination: 0
          source:
            kind: id
            value: 1
          payload:
            kind: custom
            value: [
              message:
                text: success
                timestamp: 0
            ] # vec?

        # Post sent to subscriber(s)
        - destination: 0
          source:
            kind: id
            value: 1
          payload:
            kind: custom
            value:
              message:
                text: "Hello world",
                timestamp: ???

        # Post success
        - destination: 0
          source:
            kind: id
            value: 1
          payload:
            kind: custom
            value: [
              message:
                text: success,
                timestamp: 0,
            ] # vec?

        # ChannelFeed
        - destination: 0
          source:
            kind: id
            value: 1
          payload:
            kind: custom
            value: [
              message:
                text: "Channel Test was created by ???"
                timestamp: ???,
              message:
                text: "Hello world!"
                timestamp: ???
            ] # vec?
